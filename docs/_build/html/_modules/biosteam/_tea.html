

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>biosteam._tea &mdash; BioSTEAM 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'0.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> BioSTEAM
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Getting started.html">1. Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MixedStream objects and thermodynamic equilibrium.html">2. MixedStream objects and thermodynamic equilibrium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Creating a Unit.html">3. Creating a Unit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Unit operation examples.html">4. Unit operation examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Find unit operations and manage flowsheets.html">5. Find unit operations and manage flowsheets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Using -pipe- notation.html">6. Using -pipe- notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Techno-economic analysis of a biorefinery.html">7. Techno-economic analysis of a biorefinery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Inheriting from Unit.html">8. Inheriting from Unit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Unit decorators.html">9. Unit decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Stoichiometric reactions.html">10. Stoichiometric reactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Advanced simulation.html">11. Advanced simulation</a></li>
</ul>
<p class="caption"><span class="caption-text">BioSTEAM API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Species.html">Species</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Stream.html">Stream</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MixedStream.html">MixedStream</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Unit.html">Unit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PowerUtility.html">PowerUtility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HeatUtility.html">HeatUtility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../System.html">System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TEA.html">TEA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Flowsheet.html">find</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../compounds.html">compounds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inspect.html">inspect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reaction.html">reaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../evaluation.html">evaluation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BioSTEAM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>biosteam._tea</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for biosteam._tea</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Feb  4 19:38:37 2019</span>

<span class="sd">@author: Guest Group</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">._utils</span> <span class="k">import</span> <span class="n">wegstein_secant</span><span class="p">,</span> <span class="n">aitken_secant</span><span class="p">,</span> <span class="n">secant</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span> <span class="k">as</span> <span class="n">copy_</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEA&#39;</span><span class="p">,</span> <span class="s1">&#39;CombinedTEA&#39;</span><span class="p">)</span>


<span class="c1"># TODO: Add &#39;SL&#39;, &#39;DB&#39;, &#39;DDB&#39;, &#39;SYD&#39;, &#39;ACRS&#39; and &#39;MACRS&#39; functions to generate depreciation data</span>

<span class="c1"># %% Depreciation data</span>

<span class="n">_MACRS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MACRS5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">2000</span><span class="p">,</span> <span class="o">.</span><span class="mi">3200</span><span class="p">,</span> <span class="o">.</span><span class="mi">1920</span><span class="p">,</span>
                             <span class="o">.</span><span class="mi">1152</span><span class="p">,</span> <span class="o">.</span><span class="mi">1152</span><span class="p">,</span> <span class="o">.</span><span class="mi">0576</span><span class="p">]),</span>
          
          <span class="s1">&#39;MACRS7&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">1429</span><span class="p">,</span> <span class="o">.</span><span class="mi">2449</span><span class="p">,</span> <span class="o">.</span><span class="mi">1749</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">1249</span><span class="p">,</span> <span class="o">.</span><span class="mi">0893</span><span class="p">,</span> <span class="o">.</span><span class="mi">0892</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0893</span><span class="p">,</span> <span class="o">.</span><span class="mi">0446</span><span class="p">]),</span>
          
          <span class="s1">&#39;MACRS10&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">1000</span><span class="p">,</span> <span class="o">.</span><span class="mi">1800</span><span class="p">,</span> <span class="o">.</span><span class="mi">1440</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">1152</span><span class="p">,</span> <span class="o">.</span><span class="mi">0922</span><span class="p">,</span> <span class="o">.</span><span class="mi">0737</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0655</span><span class="p">,</span> <span class="o">.</span><span class="mi">0655</span><span class="p">,</span> <span class="o">.</span><span class="mi">0656</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0655</span><span class="p">,</span> <span class="o">.</span><span class="mi">0328</span><span class="p">]),</span>

          <span class="s1">&#39;MACRS15&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">0500</span><span class="p">,</span> <span class="o">.</span><span class="mi">0950</span><span class="p">,</span> <span class="o">.</span><span class="mi">0855</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0770</span><span class="p">,</span> <span class="o">.</span><span class="mi">0693</span><span class="p">,</span> <span class="o">.</span><span class="mi">0623</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0590</span><span class="p">,</span> <span class="o">.</span><span class="mi">0590</span><span class="p">,</span> <span class="o">.</span><span class="mi">0591</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0590</span><span class="p">,</span> <span class="o">.</span><span class="mi">0591</span><span class="p">,</span> <span class="o">.</span><span class="mi">0590</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0591</span><span class="p">,</span> <span class="o">.</span><span class="mi">0590</span><span class="p">,</span> <span class="o">.</span><span class="mi">0591</span><span class="p">,</span>
                               <span class="o">.</span><span class="mi">0295</span><span class="p">]),</span>

          <span class="s1">&#39;MACRS20&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.03750</span><span class="p">,</span> <span class="mf">0.07219</span><span class="p">,</span> <span class="mf">0.06677</span><span class="p">,</span>
                               <span class="mf">0.06177</span><span class="p">,</span> <span class="mf">0.05713</span><span class="p">,</span> <span class="mf">0.05285</span><span class="p">,</span>
                               <span class="mf">0.04888</span><span class="p">,</span> <span class="mf">0.04522</span><span class="p">,</span> <span class="mf">0.4462</span><span class="p">,</span>
                               <span class="mf">0.04461</span><span class="p">,</span> <span class="mf">0.04462</span><span class="p">,</span> <span class="mf">0.04461</span><span class="p">,</span>
                               <span class="mf">0.04462</span><span class="p">,</span> <span class="mf">0.04461</span><span class="p">,</span> <span class="mf">0.04462</span><span class="p">,</span>
                               <span class="mf">0.04461</span><span class="p">,</span> <span class="mf">0.04462</span><span class="p">,</span> <span class="mf">0.04461</span><span class="p">,</span>
                               <span class="mf">0.04462</span><span class="p">,</span> <span class="mf">0.04461</span><span class="p">,</span> <span class="mf">0.02231</span><span class="p">])}</span>


<span class="c1"># %% Utilities</span>
        
<span class="k">def</span> <span class="nf">initial_loan_principal</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">interest</span><span class="p">):</span>
    <span class="n">principal</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">loan_i</span> <span class="ow">in</span> <span class="n">loan</span><span class="p">:</span>
        <span class="n">principal</span> <span class="o">=</span> <span class="n">loan_i</span> <span class="o">+</span> <span class="n">principal</span> <span class="o">*</span> <span class="n">interest</span>
    <span class="k">return</span> <span class="n">principal</span>

<span class="k">def</span> <span class="nf">final_loan_principal</span><span class="p">(</span><span class="n">payment</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="n">interest</span><span class="p">,</span> <span class="n">years</span><span class="p">):</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">years</span><span class="p">):</span>
        <span class="n">principal</span> <span class="o">+=</span> <span class="n">principal</span> <span class="o">*</span> <span class="n">interest</span> <span class="o">-</span> <span class="n">payment</span>
    <span class="k">return</span> <span class="n">principal</span>

<span class="k">def</span> <span class="nf">solve_payment</span><span class="p">(</span><span class="n">payment</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">interest</span><span class="p">,</span> <span class="n">years</span><span class="p">):</span>
    <span class="n">principal</span> <span class="o">=</span> <span class="n">initial_loan_principal</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">interest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wegstein_secant</span><span class="p">(</span><span class="n">final_loan_principal</span><span class="p">,</span>
                           <span class="n">payment</span><span class="p">,</span> <span class="n">payment</span><span class="o">+</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span>
                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">principal</span><span class="p">,</span> <span class="n">interest</span><span class="p">,</span> <span class="n">years</span><span class="p">))</span>


<span class="c1"># %% Techno-Economic Analysis</span>

<div class="viewcode-block" id="TEA"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA">[docs]</a><span class="k">class</span> <span class="nc">TEA</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstract TEA class for cash flow analysis.</span>
<span class="sd">    </span>
<span class="sd">        **Abstract methods**</span>
<span class="sd">        </span>
<span class="sd">            **_TDC:** [function] Should take direct permanent investment as an argument and return total depreciable capital (e.g. _TDC(self, DPI) -&gt; TDC).</span>
<span class="sd">            </span>
<span class="sd">            **_FCI:** [function] Should take total depreciable capital as an argument and return fixed capital investment (e.g. _FCI(self, TDC) -&gt; FCI).</span>
<span class="sd">            </span>
<span class="sd">            **_FOC:** [function] Should take fixed capital investment as an arguments and return fixed operating cost without depreciation (e.g. _FOC(self, FCI) -&gt; FOC).</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**</span>
<span class="sd">        </span>
<span class="sd">            **system:** [System] Should contain feed and product streams.</span>
<span class="sd">            </span>
<span class="sd">            **IRR:** [float]  Internal rate of return (fraction).</span>
<span class="sd">            </span>
<span class="sd">            **duration:** tuple[int, int] Start and end year of venture (e.g. (2018, 2038)).</span>
<span class="sd">            </span>
<span class="sd">            **depreciation:** [str] &#39;MACRS&#39; + number of years (e.g. &#39;MACRS7&#39;).</span>
<span class="sd">            </span>
<span class="sd">            **operating_days:** [float] Number of operating days per year.</span>
<span class="sd">            </span>
<span class="sd">            **income_tax:** [float] Combined federal and state income tax rate (fraction).</span>
<span class="sd">            </span>
<span class="sd">            **lang_factor:** [float] Lang factor for getting fixed capital investment from total purchase cost. If no lang factor, estimate capital investment using bare module factors.</span>
<span class="sd">            </span>
<span class="sd">            **construction_schedule:** tuple[float] Construction investment fractions per year (e.g. (0.5, 0.5) for 50% capital investment in the first year and 50% investment in the second).</span>
<span class="sd">            </span>
<span class="sd">            **startup_months:** [float] Startup time in months.</span>
<span class="sd">            </span>
<span class="sd">            **startup_FOCfrac:** [float] Fraction of fixed operating costs incurred during startup.</span>
<span class="sd">            </span>
<span class="sd">            **startup_VOCfrac:** [float] Fraction of variable operating costs incurred during startup.</span>
<span class="sd">            </span>
<span class="sd">            **startup_salesfrac:** [float] Fraction of sales achieved during startup.</span>
<span class="sd">            </span>
<span class="sd">            **WC_over_FCI**: [float] Working capital as a fraction of fixed capital investment.</span>
<span class="sd">            </span>
<span class="sd">            **finanace_interest:** [float] Yearly interest of capital cost financing as a fraction.</span>
<span class="sd">            </span>
<span class="sd">            **finance_years:** [int] Number of years the loan is paid for.</span>
<span class="sd">            </span>
<span class="sd">            **finance_fraction:** [float] Fraction of capital cost that needs to be financed.</span>
<span class="sd">                        </span>
<span class="sd">        **Examples**</span>
<span class="sd">        </span>
<span class="sd">            :doc:`Techno-economic analysis of a biorefinery` </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;income_tax&#39;</span><span class="p">,</span> <span class="s1">&#39;lang_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;WC_over_FCI&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;finance_interest&#39;</span><span class="p">,</span> <span class="s1">&#39;finance_years&#39;</span><span class="p">,</span> <span class="s1">&#39;finance_fraction&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_construction_schedule&#39;</span><span class="p">,</span> <span class="s1">&#39;_startup_time&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;startup_FOCfrac&#39;</span><span class="p">,</span> <span class="s1">&#39;startup_VOCfrac&#39;</span><span class="p">,</span> <span class="s1">&#39;startup_salesfrac&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;_startup_schedule&#39;</span><span class="p">,</span> <span class="s1">&#39;_operating_days&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_annual_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;_duration_array&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_depreciation_array&#39;</span><span class="p">,</span> <span class="s1">&#39;_depreciation&#39;</span><span class="p">,</span> <span class="s1">&#39;_years&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;_start&#39;</span><span class="p">,</span>  <span class="s1">&#39;IRR&#39;</span><span class="p">,</span> <span class="s1">&#39;_IRR&#39;</span><span class="p">,</span> <span class="s1">&#39;_sales&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isabstract</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isabstract</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_TDC&#39;</span><span class="p">,</span> <span class="s1">&#39;_FCI&#39;</span><span class="p">,</span> <span class="s1">&#39;_FOC&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;subclass must implement a &#39;</span><span class="si">{method}</span><span class="s2">&#39; method unless the &#39;isabstract&#39; keyword argument is True&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TEA.like"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.like">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Cashflow object from `system` with the same settings as `other`.&quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">copy_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_costunits</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_TEA</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">IRR</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">depreciation</span><span class="p">,</span> <span class="n">income_tax</span><span class="p">,</span>
                 <span class="n">operating_days</span><span class="p">,</span> <span class="n">lang_factor</span><span class="p">,</span> <span class="n">construction_schedule</span><span class="p">,</span>
                 <span class="n">startup_months</span><span class="p">,</span> <span class="n">startup_FOCfrac</span><span class="p">,</span> <span class="n">startup_VOCfrac</span><span class="p">,</span>
                 <span class="n">startup_salesfrac</span><span class="p">,</span> <span class="n">WC_over_FCI</span><span class="p">,</span> <span class="n">finance_interest</span><span class="p">,</span>
                 <span class="n">finance_years</span><span class="p">,</span> <span class="n">finance_fraction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depreciation</span> <span class="o">=</span> <span class="n">depreciation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">construction_schedule</span> <span class="o">=</span> <span class="n">construction_schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_months</span> <span class="o">=</span> <span class="n">startup_months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_days</span> <span class="o">=</span> <span class="n">operating_days</span>
        
        <span class="c1">#: [float]  Internal rate of return (fraction).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IRR</span> <span class="o">=</span> <span class="n">IRR</span>
        
        <span class="c1">#: [float] Combined federal and state income tax rate (fraction).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span> <span class="o">=</span> <span class="n">income_tax</span>
        
        <span class="c1">#: [float] Lang factor for getting fixed capital investment from total purchase cost. If no lang factor, estimate capital investment using bare module factors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang_factor</span> <span class="o">=</span> <span class="n">lang_factor</span>
        
        <span class="c1">#: [float] Fraction of fixed operating costs incurred during startup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_FOCfrac</span> <span class="o">=</span> <span class="n">startup_FOCfrac</span>
        
        <span class="c1">#: [float] Fraction of variable operating costs incurred during startup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_VOCfrac</span> <span class="o">=</span> <span class="n">startup_VOCfrac</span>
        
        <span class="c1">#: [float] Fraction of sales achieved during startup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_salesfrac</span> <span class="o">=</span> <span class="n">startup_salesfrac</span>
        
        <span class="c1">#: [float] Working capital as a fraction of fixed capital investment.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span> <span class="o">=</span> <span class="n">WC_over_FCI</span>
        
        <span class="c1">#: [float] Yearly interest of capital cost financing as a fraction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finance_interest</span> <span class="o">=</span> <span class="n">finance_interest</span>
        
        <span class="c1">#: [int] Number of years the loan is paid for.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finance_years</span> <span class="o">=</span> <span class="n">finance_years</span>
        
        <span class="c1">#: [float] Fraction of capital cost that needs to be financed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finance_fraction</span> <span class="o">=</span> <span class="n">finance_fraction</span>
        
        <span class="c1">#: Guess IRR for solve_IRR method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">IRR</span>
        
        <span class="c1">#: Guess cost for solve_price method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1">#: list[Unit] All unit operations considered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_costunits</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
        
        <span class="c1">#: [System] Should contain feed and product streams.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_TEA</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">operating_days</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[float] Number of operating days per year.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_operating_days</span>
    <span class="nd">@operating_days</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">operating_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[float] Number of operating days per year.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_operating_days</span> <span class="o">=</span> <span class="n">days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annual_factor</span> <span class="o">=</span> <span class="n">days</span><span class="o">*</span><span class="mi">24</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tuple[int, int] Start and end year of venture.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span>
    <span class="nd">@duration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_years</span> <span class="o">=</span> <span class="n">duration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">depreciation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[str] &#39;MACRS&#39; + number of years (e.g. &#39;MACRS7&#39;).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depreciation</span>
    <span class="nd">@depreciation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">depreciation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depreciation</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_depreciation_array</span> <span class="o">=</span> <span class="n">_MACRS</span><span class="p">[</span><span class="n">depreciation</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;depreciation must be either &#39;MACRS5&#39;, &#39;MACRS7&#39;, &#39;MACRS10&#39; or &#39;MACRS15 (not {repr(depreciation)})&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depreciation</span> <span class="o">=</span> <span class="n">depreciation</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">construction_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tuple[float] Construction investment fractions per year, starting from year 0. For example, for 50% capital investment in year 0 and 50% investment in year 1: (0.5, 0.5).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_construction_schedule</span><span class="p">)</span>
    <span class="nd">@construction_schedule</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">construction_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construction_schedule</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">schedule</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">startup_months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_time</span> <span class="o">*</span> <span class="mf">12.</span>
    <span class="nd">@startup_months</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">startup_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">months</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">months</span> <span class="o">&lt;=</span> <span class="mf">12.</span><span class="p">,</span> <span class="s2">&quot;startup time must be less than a year&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup_time</span> <span class="o">=</span> <span class="n">months</span><span class="o">/</span><span class="mf">12.</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">utility_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total utility cost (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">utility_cost</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annual_factor</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purchase_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total purchase cost (USD).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">purchase_cost</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">installation_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total installation cost (USD).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">installation_cost</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DPI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Direct permanent investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">purchase_cost</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_factor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_factor</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">installation_cost</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TDC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total depreciable capital.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TDC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DPI</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">FCI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed capital investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FCI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TDC</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TCI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total capital investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">FCI</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">FOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed operating costs (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FOC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FCI</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Variable operating costs (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_cost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_cost</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">AOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual operating cost excluding depreciation (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOC</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">working_capital</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TDC</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">material_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual material cost.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">feeds</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">price</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annual_factor</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annual_depreciation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Depreciation (USD/yr) equivalent to FCI dived by the the duration of the venture.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCI</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sales</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual sales revenue.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">products</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">price</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annual_factor</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return on investment (1/yr) without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="n">FCI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCI</span>
        <span class="n">net_earnings</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_AOC</span><span class="p">(</span><span class="n">FCI</span><span class="p">))</span>
        <span class="n">TCI</span> <span class="o">=</span> <span class="n">FCI</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">net_earnings</span><span class="o">/</span><span class="n">TCI</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">net_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Net earnings without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PBP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pay back period (yr) without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="n">FCI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCI</span>
        <span class="n">net_earnings</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_AOC</span><span class="p">(</span><span class="n">FCI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FCI</span><span class="o">/</span><span class="n">net_earnings</span>

<div class="viewcode-block" id="TEA.get_cashflow"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.get_cashflow">[docs]</a>    <span class="k">def</span> <span class="nf">get_cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return DataFrame of the cash flow analysis.&quot;&quot;&quot;</span>
        <span class="c1"># Cash flow data and parameters</span>
        <span class="c1"># index: Year since construction until end of venture</span>
        <span class="c1"># C_D: Depreciable capital</span>
        <span class="c1"># C_FC: Fixed capital</span>
        <span class="c1"># C_WC: Working capital</span>
        <span class="c1"># D: Depreciation</span>
        <span class="c1"># L: Loan revenue</span>
        <span class="c1"># LI: Loan interest</span>
        <span class="c1"># LIP: Loan interest payment</span>
        <span class="c1"># LP: Loan principal</span>
        <span class="c1"># C: Annual operating cost (excluding depreciation)</span>
        <span class="c1"># S: Sales</span>
        <span class="c1"># NE: Net earnings</span>
        <span class="c1"># CF: Cash flow</span>
        <span class="c1"># DF: Discount factor</span>
        <span class="c1"># NPV: Net present value</span>
        <span class="c1"># CNPV: Cummulative NPV</span>
        <span class="n">TDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TDC</span>
        <span class="n">FCI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FCI</span><span class="p">(</span><span class="n">TDC</span><span class="p">)</span>
        <span class="n">WC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span> <span class="o">*</span> <span class="n">FCI</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
        <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_years</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">years</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">years</span>
        <span class="n">C_D</span><span class="p">,</span> <span class="n">C_FC</span><span class="p">,</span> <span class="n">C_WC</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LIP</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">NE</span><span class="p">,</span> <span class="n">CF</span><span class="p">,</span> <span class="n">DF</span><span class="p">,</span> <span class="n">NPV</span><span class="p">,</span> <span class="n">CNPV</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">15</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
        <span class="n">construction_schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construction_schedule</span>
        <span class="n">C_FC</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">FCI</span><span class="o">*</span><span class="n">construction_schedule</span>
        <span class="n">C_D</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">TDC</span><span class="o">*</span><span class="n">construction_schedule</span>
        <span class="n">depreciation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depreciation_array</span>
        <span class="n">D</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">depreciation</span><span class="p">)]</span> <span class="o">=</span> <span class="n">TDC</span><span class="o">*</span><span class="n">depreciation</span>
        <span class="n">C_WC</span><span class="p">[</span><span class="n">start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WC</span>
        <span class="n">C_WC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">WC</span>
        <span class="n">FOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FOC</span><span class="p">(</span><span class="n">FCI</span><span class="p">)</span>
        <span class="n">VOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_time</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w0</span>
        <span class="n">C</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_VOCfrac</span><span class="o">*</span><span class="n">VOC</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">VOC</span>
                    <span class="o">+</span> <span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_FOCfrac</span><span class="o">*</span><span class="n">FOC</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">FOC</span><span class="p">)</span>
        <span class="n">S</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_salesfrac</span><span class="o">*</span><span class="n">sales</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">sales</span>
        <span class="n">start1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">C</span><span class="p">[</span><span class="n">start1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">VOC</span> <span class="o">+</span> <span class="n">FOC</span>
        <span class="n">S</span><span class="p">[</span><span class="n">start1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sales</span>
        <span class="n">NE</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">C</span> <span class="o">-</span> <span class="n">D</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_interest</span><span class="p">:</span>
            <span class="n">interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_interest</span>
            <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_years</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">years</span>
            <span class="n">L</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">loan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_fraction</span><span class="o">*</span><span class="p">(</span><span class="n">C_FC</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span><span class="o">+</span><span class="n">C_WC</span><span class="p">[:</span><span class="n">start</span><span class="p">])</span>
            <span class="n">f_interest</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">interest</span><span class="p">)</span>
            <span class="n">LIP</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_payment</span><span class="p">(</span><span class="n">loan</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">years</span> <span class="o">*</span> <span class="n">f_interest</span><span class="p">,</span>
                                           <span class="n">loan</span><span class="p">,</span> <span class="n">interest</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span>
            <span class="n">LI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">interest</span>
            <span class="n">LP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">LIP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="n">LI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">interest</span> 
                <span class="n">LP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">LIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">LI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">CF</span><span class="p">[:]</span> <span class="o">=</span>  <span class="n">NE</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">L</span> <span class="o">-</span> <span class="n">C_FC</span> <span class="o">-</span> <span class="n">C_WC</span> <span class="o">-</span> <span class="n">LIP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CF</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">NE</span> <span class="o">+</span> <span class="n">D</span> <span class="o">-</span> <span class="n">C_FC</span> <span class="o">-</span> <span class="n">C_WC</span>
        <span class="n">DF</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">IRR</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_duration_array</span>
        <span class="n">NPV</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">CF</span><span class="o">*</span><span class="n">DF</span>
        <span class="n">CNPV</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">NPV</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span>
                            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Depreciable capital&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Fixed capital investment&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Working capital&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Depreciation&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Loan&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Loan interest&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Loan interest payment&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Loan principal&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Annual operating cost (excluding depreciation)&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Sales&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Net earnings&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Cash flow&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Discount factor&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Net present value (NPV)&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Cummulative NPV&#39;</span><span class="p">))</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NPV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Net present value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IRR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cashflow</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_AOC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FCI</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return AOC at given FCI&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FOC</span><span class="p">(</span><span class="n">FCI</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span>
    
<div class="viewcode-block" id="TEA.production_cost"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.production_cost">[docs]</a>    <span class="k">def</span> <span class="nf">production_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">products</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return production cost of products.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**</span>
<span class="sd">        </span>
<span class="sd">            ***products:** [Stream] Main products of the system</span>
<span class="sd">        </span>
<span class="sd">        .. Note::</span>
<span class="sd">           If there is more than one main product, The production cost is proportionally allocated to each of the main products with respect to their marketing values. The marketing value of each product is determined by the annual production multiplied by its selling price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">market_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">products</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">market_values</span><span class="o">/</span><span class="n">market_values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">weights</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC</span></div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Cash flow data and parameters</span>
        <span class="c1"># C_FC: Fixed capital</span>
        <span class="c1"># C_WC: Working capital</span>
        <span class="c1"># Loan: Money gained from loan</span>
        <span class="c1"># LIP: Loan interest payment</span>
        <span class="c1"># D: Depreciation</span>
        <span class="c1"># C: Annual operating cost (excluding depreciation)</span>
        <span class="c1"># S: Sales</span>
        <span class="c1"># NE: Net earnings</span>
        <span class="c1"># CF: Cash flow</span>
        <span class="n">TDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TDC</span>
        <span class="n">FCI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FCI</span><span class="p">(</span><span class="n">TDC</span><span class="p">)</span>
        <span class="n">WC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WC_over_FCI</span> <span class="o">*</span> <span class="n">FCI</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
        <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_years</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">years</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">C_FC</span><span class="p">,</span> <span class="n">C_WC</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">LIP</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="n">start</span><span class="o">+</span><span class="n">years</span><span class="p">))</span>
        <span class="n">construction_schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construction_schedule</span>
        <span class="n">C_FC</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">FCI</span><span class="o">*</span><span class="n">construction_schedule</span>
        <span class="n">depreciation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depreciation_array</span>
        <span class="n">D</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">depreciation</span><span class="p">)]</span> <span class="o">=</span> <span class="n">TDC</span><span class="o">*</span><span class="n">depreciation</span>
        <span class="n">C_WC</span><span class="p">[</span><span class="n">start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WC</span>
        <span class="n">C_WC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">WC</span>
        <span class="n">FOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FOC</span><span class="p">(</span><span class="n">FCI</span><span class="p">)</span>
        <span class="n">VOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_time</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w0</span>
        <span class="n">C</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_VOCfrac</span><span class="o">*</span><span class="n">VOC</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">VOC</span>
                    <span class="o">+</span> <span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_FOCfrac</span><span class="o">*</span><span class="n">FOC</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">FOC</span><span class="p">)</span>
        <span class="n">S</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_salesfrac</span><span class="o">*</span><span class="n">sales</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">sales</span>
        <span class="n">start1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">C</span><span class="p">[</span><span class="n">start1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">VOC</span> <span class="o">+</span> <span class="n">FOC</span>
        <span class="n">S</span><span class="p">[</span><span class="n">start1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sales</span>
        <span class="n">NE</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">C</span> <span class="o">-</span> <span class="n">D</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_interest</span><span class="p">:</span>
            <span class="n">interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_interest</span>
            <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_years</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">years</span>
            <span class="n">Loan</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">loan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finance_fraction</span><span class="o">*</span><span class="p">(</span><span class="n">C_FC</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span><span class="o">+</span><span class="n">C_WC</span><span class="p">[:</span><span class="n">start</span><span class="p">])</span>
            <span class="n">LIP</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_payment</span><span class="p">(</span><span class="n">loan</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">years</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">interest</span><span class="p">),</span>
                                           <span class="n">loan</span><span class="p">,</span> <span class="n">interest</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">NE</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">Loan</span> <span class="o">-</span> <span class="n">C_FC</span> <span class="o">-</span> <span class="n">C_WC</span> <span class="o">-</span> <span class="n">LIP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NE</span> <span class="o">+</span> <span class="n">D</span> <span class="o">-</span> <span class="n">C_FC</span> <span class="o">-</span> <span class="n">C_WC</span>
    
    <span class="k">def</span> <span class="nf">_NPV_at_IRR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IRR</span><span class="p">,</span> <span class="n">cashflow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NPV at given IRR and cashflow data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cashflow</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">IRR</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_duration_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_NPV_with_sales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sales</span><span class="p">,</span> <span class="n">NPV</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">discount_factors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NPV with an additional annualized sales.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">NPV</span> <span class="o">+</span> <span class="p">(</span><span class="n">sales</span><span class="o">*</span><span class="n">coefficients</span><span class="o">/</span><span class="n">discount_factors</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<div class="viewcode-block" id="TEA.solve_IRR"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.solve_IRR">[docs]</a>    <span class="k">def</span> <span class="nf">solve_IRR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the IRR at the break even point (NPV = 0) through cash flow analysis.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">aitken_secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span>
                                      <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cashflow</span><span class="p">,))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">,</span>
                               <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15001</span><span class="p">,</span>
                               <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cashflow</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span></div>
    
    <span class="k">def</span> <span class="nf">_price2cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get factor to convert stream price to cost for cashflow in solve_price method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">massnet</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_annual_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">income_tax</span><span class="p">)</span>
    
<div class="viewcode-block" id="TEA.solve_price"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.solve_price">[docs]</a>    <span class="k">def</span> <span class="nf">solve_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the price (USD/kg) of stream at the break even point (NPV = 0) through cash flow analysis. </span>
<span class="sd">        </span>
<span class="sd">        **Parameters**</span>
<span class="sd">        </span>
<span class="sd">            **stream:** [Stream] Stream with variable selling price.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price2cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_price2cost</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">discount_factors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">IRR</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_duration_array</span>
        <span class="n">cashflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cashflow</span>
        <span class="n">NPV</span> <span class="o">=</span> <span class="p">(</span><span class="n">cashflow</span><span class="o">/</span><span class="n">discount_factors</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">discount_factors</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
        <span class="n">coefficients</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_time</span>
        <span class="n">coefficients</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">]</span> <span class="o">=</span>  <span class="n">w0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_VOCfrac</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="n">aitken_secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_with_sales</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span>
                                        <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">NPV</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">discount_factors</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="n">secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_with_sales</span><span class="p">,</span>
                                 <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span>
                                 <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                 <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">NPV</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">discount_factors</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">/</span><span class="n">price2cost</span>
        <span class="k">elif</span> <span class="n">stream</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">/</span><span class="n">price2cost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;stream must be either a feed or a product&quot;</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;&lt;{type(self).__name__}: </span><span class="si">{self.system.ID}</span><span class="s1">&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;{type(self).__name__}: </span><span class="si">{self.system.ID}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; NPV: </span><span class="si">{self.NPV:.3g}</span><span class="s1"> USD at </span><span class="si">{self.IRR:.1%}</span><span class="s1"> IRR</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; ROI: </span><span class="si">{self.ROI:.3g}</span><span class="s1"> 1/yr</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; PBP: </span><span class="si">{self.PBP:.3g}</span><span class="s1"> yr&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="TEA.show"><a class="viewcode-back" href="../../TEA.html#biosteam.TEA.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints information on unit.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">())</span></div>
    <span class="n">_ipython_display_</span> <span class="o">=</span> <span class="n">show</span></div>
                
    
<span class="k">class</span> <span class="nc">CombinedTEA</span><span class="p">(</span><span class="n">TEA</span><span class="p">):</span>
    
    <span class="n">_TDC</span> <span class="o">=</span> <span class="n">_FCI</span> <span class="o">=</span> <span class="n">_FOC</span> <span class="o">=</span> <span class="bp">NotImplemented</span>
    
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEAs&#39;</span><span class="p">,)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TEAs</span><span class="p">,</span> <span class="n">IRR</span><span class="p">):</span>
        <span class="c1">#: iterable[TEA] All TEA objects for cashflow calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span> <span class="o">=</span> <span class="n">TEAs</span>
        
        <span class="c1">#: [float] Internal rate of return (fraction)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IRR</span> <span class="o">=</span> <span class="n">IRR</span>
        
        <span class="c1">#: Guess IRR for solve_IRR method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">IRR</span>
        
        <span class="c1">#: Guess sales for solve_price method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">cashflow</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">utility_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total utility cost (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">utility_cost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purchase_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total purchase cost (USD).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">purchase_cost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">installation_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total installation cost (USD).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">installation_cost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NPV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">NPV</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DPI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Direct permanent investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">DPI</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TDC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total depreciable capital.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">TDC</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">FCI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed capital investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">FCI</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TCI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total capital investment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">TCI</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">FOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed operating costs (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">FOC</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Variable operating costs (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_cost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_cost</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">AOC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual operating cost excluding depreciation (USD/yr).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOC</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">working_capital</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">working_capital</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">material_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual material cost.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">material_cost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annual_depreciation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Depreciation (USD/yr) equivalent to FCI dived by the the duration of the venture.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">annual_depreciation</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sales</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annual sales revenue.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">sales</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">net_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Net earnings without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">net_earnings</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return on investment (1/yr) without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">ROI</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PBP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pay back period (yr) without accounting for annualized depreciation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCI</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">net_earnings</span>
    
    <span class="k">def</span> <span class="nf">get_cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return DataFrame of the cash flow analysis.&quot;&quot;&quot;</span>
        <span class="n">TEA</span><span class="p">,</span> <span class="o">*</span><span class="n">TEAs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">TEA</span><span class="o">.</span><span class="n">get_cashflow</span><span class="p">()</span>
        <span class="n">DF</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Discount factor&#39;</span><span class="p">]</span>
        <span class="n">DF_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">TEAs</span><span class="p">:</span>
            <span class="n">i_table</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">get_cashflow</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_table</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;cannot create cashflow table from TEAs with different venture years&#39;</span><span class="p">)</span>
            <span class="n">table</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">i_table</span><span class="p">)</span>
        <span class="n">DF</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DF_data</span>
        <span class="k">return</span> <span class="n">table</span>    
        
    <span class="k">def</span> <span class="nf">_NPV_at_IRR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IRR</span><span class="p">,</span> <span class="n">TEA_cashflows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NPV at given IRR and cashflow data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">(</span><span class="n">IRR</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">TEA_cashflows</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_NPV_with_sales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sales</span><span class="p">,</span> <span class="n">NPV</span><span class="p">,</span> <span class="n">TEA</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">discount_factors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NPV with additional sales.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TEA</span><span class="o">.</span><span class="n">_NPV_with_sales</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="n">NPV</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">discount_factors</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">solve_IRR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the IRR at the break even point (NPV = 0) through cash flow analysis.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">aitken_secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span>
                                      <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                      <span class="n">args</span><span class="o">=</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">cashflow</span><span class="p">)</span>
                                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">],))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span> <span class="o">=</span> <span class="n">secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">,</span>
                               <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15001</span><span class="p">,</span>
                               <span class="n">xtol</span><span class="o">=</span><span class="mf">5e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                               <span class="n">args</span><span class="o">=</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">cashflow</span><span class="p">)</span> 
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">],))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IRR</span>
    
    <span class="k">def</span> <span class="nf">solve_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">TEA</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the price (USD/kg) of stream at the break even point (NPV = 0) through cash flow analysis. </span>
<span class="sd">        </span>
<span class="sd">        **Parameters**</span>
<span class="sd">        </span>
<span class="sd">            **stream:** [Stream] Stream with variable selling price.</span>
<span class="sd">            </span>
<span class="sd">            **TEA:** [TEA] stream should belong here.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price2cost</span> <span class="o">=</span> <span class="n">TEA</span><span class="o">.</span><span class="n">_price2cost</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">IRR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IRR</span>
        <span class="n">NPV</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">_NPV_at_IRR</span><span class="p">(</span><span class="n">IRR</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">cashflow</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEAs</span><span class="p">])</span>
        <span class="n">discount_factors</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">IRR</span><span class="p">)</span><span class="o">**</span><span class="n">TEA</span><span class="o">.</span><span class="n">_duration_array</span>
        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">discount_factors</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">TEA</span><span class="o">.</span><span class="n">_start</span>
        <span class="n">coefficients</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="n">TEA</span><span class="o">.</span><span class="n">_startup_time</span>
        <span class="n">coefficients</span><span class="p">[</span><span class="n">TEA</span><span class="o">.</span><span class="n">_start</span><span class="p">]</span> <span class="o">=</span>  <span class="n">w0</span><span class="o">*</span><span class="n">TEA</span><span class="o">.</span><span class="n">startup_VOCfrac</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="n">aitken_secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_with_sales</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">+</span><span class="mf">1e-6</span><span class="p">,</span>
                                        <span class="n">xtol</span><span class="o">=</span><span class="mf">5e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">NPV</span><span class="p">,</span> <span class="n">TEA</span><span class="p">,</span>
                                              <span class="n">coefficients</span><span class="p">,</span>
                                              <span class="n">discount_factors</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span> <span class="o">=</span> <span class="n">secant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NPV_with_sales</span><span class="p">,</span>
                                 <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span>
                                 <span class="n">xtol</span><span class="o">=</span><span class="mf">5e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                 <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">NPV</span><span class="p">,</span> <span class="n">TEA</span><span class="p">,</span>
                                       <span class="n">coefficients</span><span class="p">,</span>
                                       <span class="n">discount_factors</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">/</span><span class="n">price2cost</span>
        <span class="k">elif</span> <span class="n">stream</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sales</span><span class="o">/</span><span class="n">price2cost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;stream must be either a feed or a product&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;&lt;{type(self).__name__}: {&quot;, &quot;.join([i.system.ID for i in self.TEAs])}&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;{type(self).__name__}: {&quot;, &quot;.join([i.system.ID for i in self.TEAs])}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; NPV: </span><span class="si">{self.NPV:.3g}</span><span class="s1"> USD at </span><span class="si">{self.IRR:.1%}</span><span class="s1"> IRR</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; ROI: </span><span class="si">{self.ROI:.3g}</span><span class="s1"> 1/yr</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f</span><span class="s1">&#39; PBP: </span><span class="si">{self.PBP:.3g}</span><span class="s1"> yr&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints information on unit.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">())</span>
    <span class="n">_ipython_display_</span> <span class="o">=</span> <span class="n">show</span>
    
    
    
<span class="c1"># def update_loan_principal(loan_principal, loan, loan_payment, interest):</span>
<span class="c1">#     principal = 0</span>
<span class="c1">#     for i, loan_i in enumerate(loan):</span>
<span class="c1">#         loan_principal[i] = principal = loan_i + principal * interest - loan_payment[i]</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Yoel Cortes-Pena and Jeremy Guest

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>